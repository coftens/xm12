import React, { useState, useEffect } from 'react'
import { Card, CardContent } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { Progress } from '@/components/ui/progress'
import { ScanSearch, AlertTriangle, ShieldAlert, ShieldCheck, Info, Play, Server, Clock, ChevronDown, ChevronUp, RefreshCcw } from 'lucide-react'
import api from '@/api'

const severityConfig = {
    critical: { color: 'text-red-500', bgColor: 'bg-red-500/10', icon: ShieldAlert, label: '严重' },
    high: { color: 'text-amber-500', bgColor: 'bg-amber-500/10', icon: AlertTriangle, label: '高危' },
    medium: { color: 'text-sky-500', bgColor: 'bg-sky-500/10', icon: Info, label: '中危' },
    low: { color: 'text-muted-foreground', bgColor: 'bg-secondary', icon: Info, label: '低危' },
}

export function VulnerabilityScan() {
    const [servers, setServers] = useState([])
    const [selectedServerId, setSelectedServerId] = useState(null)
    const [scanning, setScanning] = useState(false)
    const [progress, setProgress] = useState(0)
    const [result, setResult] = useState(null)
    const [expandedItem, setExpandedItem] = useState(null)
    const [filterSeverity, setFilterSeverity] = useState('all')

    useEffect(() => {
        const fetchServers = async () => {
            try {
                const res = await api.get('/api/servers')
                setServers(res.data)
                if (res.data.length > 0) setSelectedServerId(res.data[0].id)
            } catch (e) {
                console.error(e)
            }
        }
        fetchServers()
    }, [])

    const startScan = async () => {
        if (!selectedServerId) return
        setScanning(true)
        setProgress(0)
        setResult(null)

        // 模拟进度（实际扫描是后台运行）
        const iv = setInterval(() => setProgress(p => Math.min(p + 3, 90)), 300)

        try {
            const res = await api.post('/api/security/vulnerability-scan', { server_id: selectedServerId })
            clearInterval(iv)
            setProgress(100)
            setResult(res.data)
        } catch (e) {
            clearInterval(iv)
            alert(e.response?.data?.detail || '扫描失败')
        } finally {
            setScanning(false)
        }
    }

    const allItems = result ? [
        ...result.packages.map((p, i) => ({ ...p, id: `pkg-${i}`, type: 'package', title: `${p.package} 有可用更新` })),
        ...result.ssh_issues.map((s, i) => ({ ...s, id: `ssh-${i}`, type: 'ssh_issue', title: s.issue })),
    ] : []

    const filtered = filterSeverity === 'all' ? allItems : allItems.filter(i => i.severity === filterSeverity)
    const counts = result?.counts || { critical: 0, high: 0, medium: 0, low: 0 }

    return (
        <div className="flex flex-col gap-6 p-6">
            {/* 服务器选择 + 扫描按钮 */}
            <Card>
                <CardContent className="p-5">
                    <div className="flex items-center justify-between flex-wrap gap-4">
                        <div className="flex items-center gap-4">
                            <div className="w-12 h-12 rounded-xl bg-primary/10 flex items-center justify-center"><ScanSearch className="w-6 h-6 text-primary" /></div>
                            <div>
                                <h3 className="text-sm font-semibold">漏洞扫描</h3>
                                <p className="text-xs text-muted-foreground mt-0.5">检测可升级的安全包和 SSH 配置问题</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-3">
                            <select value={selectedServerId || ''} onChange={e => setSelectedServerId(Number(e.target.value))}
                                className="px-3 py-2 rounded-lg border border-border bg-background text-sm min-w-[160px]">
                                {servers.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                            </select>
                            <Button onClick={startScan} disabled={scanning || !selectedServerId}>
                                <Play className="w-4 h-4 mr-1.5" />{scanning ? '扫描中...' : '开始扫描'}
                            </Button>
                        </div>
                    </div>
                    {scanning && (
                        <div className="mt-4 flex flex-col gap-2">
                            <div className="flex items-center justify-between">
                                <span className="text-xs text-muted-foreground">正在扫描服务器...</span>
                                <span className="text-xs text-primary font-mono">{Math.round(progress)}%</span>
                            </div>
                            <Progress value={progress} className="h-2" />
                        </div>
                    )}
                    {result && (
                        <div className="mt-3 flex items-center gap-2">
                            <Clock className="w-3 h-3 text-muted-foreground" />
                            <span className="text-xs text-muted-foreground">扫描时间: {result.scan_time}</span>
                            <span className="text-xs text-muted-foreground">· 共发现 {result.total} 个问题</span>
                        </div>
                    )}
                </CardContent>
            </Card>

            {result && (
                <>
                    {/* 统计 */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        {[
                            { label: '严重', count: counts.critical, color: 'text-red-500', bg: 'bg-red-500/10' },
                            { label: '高危', count: counts.high, color: 'text-amber-500', bg: 'bg-amber-500/10' },
                            { label: '中危', count: counts.medium, color: 'text-sky-500', bg: 'bg-sky-500/10' },
                            { label: '低危', count: counts.low, color: 'text-muted-foreground', bg: 'bg-secondary' },
                        ].map(s => (
                            <Card key={s.label}>
                                <CardContent className="p-4 flex items-center gap-3">
                                    <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${s.bg} ${s.color} text-xl font-bold`}>{s.count}</div>
                                    <div><p className="text-xs text-muted-foreground">{s.label}漏洞</p><p className={`text-lg font-bold ${s.color}`}>{s.count}</p></div>
                                </CardContent>
                            </Card>
                        ))}
                    </div>

                    {/* 筛选 */}
                    <div className="flex items-center gap-1 p-1 rounded-lg bg-secondary/50 border border-border w-fit">
                        {['all', 'critical', 'high', 'medium', 'low'].map(sev => (
                            <button key={sev} onClick={() => setFilterSeverity(sev)}
                                className={`px-3 py-1.5 rounded-md text-xs font-medium transition-colors ${filterSeverity === sev ? 'bg-primary text-primary-foreground' : 'text-muted-foreground hover:text-foreground'}`}>
                                {sev === 'all' ? '全部' : severityConfig[sev]?.label}
                            </button>
                        ))}
                    </div>

                    {/* 结果列表 */}
                    <div className="flex flex-col gap-3">
                        {filtered.length === 0 ? (
                            <Card>
                                <CardContent className="p-8 text-center">
                                    <ShieldCheck className="w-10 h-10 mx-auto mb-2 text-emerald-500 opacity-50" />
                                    <p className="text-sm text-muted-foreground">此严重级别下无漏洞</p>
                                </CardContent>
                            </Card>
                        ) : filtered.map(item => {
                            const cfg = severityConfig[item.severity] || severityConfig.low
                            const Icon = cfg.icon
                            const isExpanded = expandedItem === item.id
                            return (
                                <Card key={item.id}>
                                    <CardContent className="p-0">
                                        <div className="flex items-center gap-4 px-5 py-4 cursor-pointer hover:bg-secondary/20 transition-colors"
                                            onClick={() => setExpandedItem(isExpanded ? null : item.id)}>
                                            <div className={`w-9 h-9 rounded-lg flex items-center justify-center shrink-0 ${cfg.bgColor}`}>
                                                <Icon className={`w-4 h-4 ${cfg.color}`} />
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <div className="flex items-center gap-2">
                                                    <span className="text-sm font-medium">{item.title}</span>
                                                    <Badge variant="outline" className={`text-[10px] px-1.5 py-0 h-4 ${cfg.bgColor} ${cfg.color}`}>{cfg.label}</Badge>
                                                </div>
                                                <div className="flex items-center gap-3 mt-1">
                                                    <div className="flex items-center gap-1"><Server className="w-3 h-3 text-muted-foreground" /><span className="text-xs text-muted-foreground">{item.server || result.server_name}</span></div>
                                                    {item.type === 'package' && item.package && (
                                                        <span className="text-xs text-muted-foreground font-mono">{item.package}</span>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="shrink-0">{isExpanded ? <ChevronUp className="w-4 h-4 text-muted-foreground" /> : <ChevronDown className="w-4 h-4 text-muted-foreground" />}</div>
                                        </div>
                                        {isExpanded && (
                                            <div className="px-5 pb-4 border-t border-border">
                                                <div className="mt-3 p-3 rounded-lg bg-secondary/30 border border-border">
                                                    {item.type === 'package' ? (
                                                        <>
                                                            <p className="text-xs text-muted-foreground mb-1">包信息</p>
                                                            <p className="text-sm font-mono">{item.raw}</p>
                                                            {item.new_version && (
                                                                <div className="flex items-center gap-2 mt-2">
                                                                    <span className="text-xs text-muted-foreground">可升级到:</span>
                                                                    <Badge variant="outline" className="text-[10px] border-emerald-500/20 text-emerald-500 bg-emerald-500/5">{item.new_version}</Badge>
                                                                </div>
                                                            )}
                                                        </>
                                                    ) : (
                                                        <>
                                                            <p className="text-xs text-muted-foreground mb-1">安全配置问题</p>
                                                            <p className="text-sm">{item.issue}</p>
                                                            {item.fix && (
                                                                <div className="mt-2">
                                                                    <span className="text-xs text-muted-foreground">修复建议: </span>
                                                                    <span className="text-sm font-mono text-primary">{item.fix}</span>
                                                                </div>
                                                            )}
                                                        </>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                    </CardContent>
                                </Card>
                            )
                        })}
                    </div>
                </>
            )}

            {!result && !scanning && (
                <Card>
                    <CardContent className="p-12 text-center">
                        <ScanSearch className="w-12 h-12 mx-auto mb-3 text-muted-foreground opacity-30" />
                        <p className="text-sm text-muted-foreground">选择服务器后点击「开始扫描」执行漏洞检测</p>
                        <p className="text-xs text-muted-foreground/60 mt-1">将检测可升级的系统包和 SSH 安全配置</p>
                    </CardContent>
                </Card>
            )}
        </div>
    )
}
