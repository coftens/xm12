import React, { useState, useEffect, useRef } from 'react'
import { Card, CardContent } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { Progress } from '@/components/ui/progress'
import { ScanSearch, AlertTriangle, ShieldAlert, ShieldCheck, Info, Play, Server, Clock, ExternalLink, ChevronDown, ChevronUp } from 'lucide-react'

const vulnerabilities = [
    { id: 'V-001', cve: 'CVE-2026-1234', title: 'OpenSSL 远程代码执行漏洞', severity: 'critical', server: 'Web-Prod-01', component: 'OpenSSL', version: '3.0.8', fixVersion: '3.0.14', status: 'open', description: '攻击者可通过精心构造的 TLS 握手包触发缓冲区溢出，实现远程代码执行。建议立即升级到修复版本。', publishDate: '2026-02-15' },
    { id: 'V-002', cve: 'CVE-2026-5678', title: 'Nginx HTTP/2 拒绝服务漏洞', severity: 'high', server: 'Web-Prod-01', component: 'Nginx', version: '1.24.0', fixVersion: '1.26.1', status: 'fixing', description: '恶意构造的 HTTP/2 请求可导致 worker 进程崩溃，造成服务中断。', publishDate: '2026-02-10' },
    { id: 'V-003', cve: 'CVE-2026-9012', title: 'MySQL 权限提升漏洞', severity: 'high', server: 'DB-Prod-03', component: 'MySQL', version: '8.0.32', fixVersion: '8.0.36', status: 'open', description: '低权限用户可利用存储过程中的逻辑漏洞提升至管理员权限。', publishDate: '2026-02-08' },
    { id: 'V-004', cve: 'CVE-2026-3456', title: 'Redis 未授权访问风险', severity: 'medium', server: 'Cache-Prod-04', component: 'Redis', version: '7.0.11', fixVersion: '7.0.15', status: 'fixed', description: '特定配置下可绕过 ACL 认证，访问受限数据。已通过配置加固修复。', publishDate: '2026-02-05' },
    { id: 'V-005', cve: 'CVE-2026-7890', title: 'Linux Kernel 本地提权', severity: 'medium', server: 'API-Prod-02', component: 'Linux Kernel', version: '5.15.0', fixVersion: '5.15.148', status: 'open', description: 'eBPF 验证器存在逻辑错误，本地用户可利用此漏洞获取 root 权限。', publishDate: '2026-02-01' },
    { id: 'V-006', cve: 'CVE-2026-2345', title: 'Node.js HTTP 请求走私', severity: 'medium', server: 'API-Prod-02', component: 'Node.js', version: '20.10.0', fixVersion: '20.11.1', status: 'fixing', description: 'HTTP 解析器在处理分块传输编码时存在不一致，可被利用进行请求走私攻击。', publishDate: '2026-01-28' },
    { id: 'V-007', cve: 'CVE-2026-6789', title: 'OpenSSH 信息泄露', severity: 'low', server: 'Web-Prod-01', component: 'OpenSSH', version: '9.3p1', fixVersion: '9.6p1', status: 'fixed', description: '特定配置下，服务器会在错误响应中泄露内部版本信息。', publishDate: '2026-01-25' },
    { id: 'V-008', cve: 'CVE-2026-0123', title: 'zlib 内存泄漏', severity: 'low', server: '全部服务器', component: 'zlib', version: '1.2.13', fixVersion: '1.3.1', status: 'open', description: '长时间运行的进程中，压缩操作可能导致轻微内存泄漏，影响性能。', publishDate: '2026-01-20' },
]

const severityConfig = {
    critical: { color: 'text-red-500', bgColor: 'bg-red-500/10', borderColor: 'border-red-500/20', icon: ShieldAlert, label: '严重' },
    high: { color: 'text-amber-500', bgColor: 'bg-amber-500/10', borderColor: 'border-amber-500/20', icon: AlertTriangle, label: '高危' },
    medium: { color: 'text-sky-500', bgColor: 'bg-sky-500/10', borderColor: 'border-sky-500/20', icon: Info, label: '中危' },
    low: { color: 'text-muted-foreground', bgColor: 'bg-secondary', borderColor: 'border-border', icon: Info, label: '低危' },
}
const statusConfig = {
    open: { color: 'bg-red-500/10 text-red-500', label: '待修复' },
    fixing: { color: 'bg-amber-500/10 text-amber-500', label: '修复中' },
    fixed: { color: 'bg-emerald-500/10 text-emerald-500', label: '已修复' },
}

export function VulnerabilityScan() {
    const [scanning, setScanning] = useState(false)
    const [progress, setProgress] = useState(0)
    const [expandedVuln, setExpandedVuln] = useState(null)
    const [filterSeverity, setFilterSeverity] = useState('all')
    const intervalRef = useRef(null)

    const startScan = () => {
        setScanning(true); setProgress(0)
        intervalRef.current = setInterval(() => {
            setProgress(p => { if (p >= 100) { clearInterval(intervalRef.current); setScanning(false); return 100 } return p + Math.random() * 8 })
        }, 200)
    }
    useEffect(() => () => { if (intervalRef.current) clearInterval(intervalRef.current) }, [])

    const counts = { critical: vulnerabilities.filter(v => v.severity === 'critical').length, high: vulnerabilities.filter(v => v.severity === 'high').length, medium: vulnerabilities.filter(v => v.severity === 'medium').length, low: vulnerabilities.filter(v => v.severity === 'low').length }
    const filtered = filterSeverity === 'all' ? vulnerabilities : vulnerabilities.filter(v => v.severity === filterSeverity)

    return (
        <div className="flex flex-col gap-6 p-6">
            <Card>
                <CardContent className="p-5">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-4">
                            <div className="w-12 h-12 rounded-xl bg-primary/10 flex items-center justify-center"><ScanSearch className="w-6 h-6 text-primary" /></div>
                            <div>
                                <h3 className="text-sm font-semibold">漏洞扫描</h3>
                                <div className="flex items-center gap-2 mt-0.5"><Clock className="w-3 h-3 text-muted-foreground" /><span className="text-xs text-muted-foreground">上次扫描: 2026-02-19 13:12:55</span></div>
                            </div>
                        </div>
                        <Button onClick={startScan} disabled={scanning}><Play className="w-4 h-4 mr-1.5" />{scanning ? '扫描中...' : '开始扫描'}</Button>
                    </div>
                    {scanning && (
                        <div className="mt-4 flex flex-col gap-2">
                            <div className="flex items-center justify-between"><span className="text-xs text-muted-foreground">正在扫描服务器漏洞...</span><span className="text-xs text-primary font-mono">{Math.min(100, Math.round(progress))}%</span></div>
                            <Progress value={Math.min(100, progress)} className="h-2" />
                        </div>
                    )}
                </CardContent>
            </Card>

            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                {[{ label: '严重', count: counts.critical, color: 'text-red-500', bg: 'bg-red-500/10' }, { label: '高危', count: counts.high, color: 'text-amber-500', bg: 'bg-amber-500/10' }, { label: '中危', count: counts.medium, color: 'text-sky-500', bg: 'bg-sky-500/10' }, { label: '低危', count: counts.low, color: 'text-muted-foreground', bg: 'bg-secondary' }].map(s => (
                    <Card key={s.label}>
                        <CardContent className="p-4 flex items-center gap-3">
                            <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${s.bg} ${s.color} text-xl font-bold`}>{s.count}</div>
                            <div><p className="text-xs text-muted-foreground">{s.label}漏洞</p><p className={`text-lg font-bold ${s.color}`}>{s.count}</p></div>
                        </CardContent>
                    </Card>
                ))}
            </div>

            <div className="flex items-center gap-1 p-1 rounded-lg bg-secondary/50 border border-border w-fit">
                {['all', 'critical', 'high', 'medium', 'low'].map(sev => (
                    <button key={sev} onClick={() => setFilterSeverity(sev)} className={`px-3 py-1.5 rounded-md text-xs font-medium transition-colors ${filterSeverity === sev ? 'bg-primary text-primary-foreground' : 'text-muted-foreground hover:text-foreground'}`}>
                        {sev === 'all' ? '全部' : severityConfig[sev]?.label}
                    </button>
                ))}
            </div>

            <div className="flex flex-col gap-3">
                {filtered.map(vuln => {
                    const cfg = severityConfig[vuln.severity]
                    const Icon = cfg.icon
                    const isExpanded = expandedVuln === vuln.id
                    return (
                        <Card key={vuln.id}>
                            <CardContent className="p-0">
                                <div className="flex items-center gap-4 px-5 py-4 cursor-pointer hover:bg-secondary/20 transition-colors" onClick={() => setExpandedVuln(isExpanded ? null : vuln.id)}>
                                    <div className={`w-9 h-9 rounded-lg flex items-center justify-center shrink-0 ${cfg.bgColor}`}><Icon className={`w-4 h-4 ${cfg.color}`} /></div>
                                    <div className="flex-1 min-w-0">
                                        <div className="flex items-center gap-2">
                                            <span className="text-sm font-medium">{vuln.title}</span>
                                            <Badge variant="outline" className={`text-[10px] px-1.5 py-0 h-4 ${cfg.bgColor} ${cfg.color} ${cfg.borderColor}`}>{cfg.label}</Badge>
                                            <Badge className={`text-[10px] border-0 ${statusConfig[vuln.status].color}`}>{statusConfig[vuln.status].label}</Badge>
                                        </div>
                                        <div className="flex items-center gap-3 mt-1">
                                            <span className="text-xs text-primary font-mono">{vuln.cve}</span>
                                            <span className="text-xs text-muted-foreground/50">|</span>
                                            <div className="flex items-center gap-1"><Server className="w-3 h-3 text-muted-foreground" /><span className="text-xs text-muted-foreground">{vuln.server}</span></div>
                                            <span className="text-xs text-muted-foreground/50">|</span>
                                            <span className="text-xs text-muted-foreground">{vuln.component} {vuln.version}</span>
                                        </div>
                                    </div>
                                    <div className="shrink-0">{isExpanded ? <ChevronUp className="w-4 h-4 text-muted-foreground" /> : <ChevronDown className="w-4 h-4 text-muted-foreground" />}</div>
                                </div>
                                {isExpanded && (
                                    <div className="px-5 pb-4 border-t border-border">
                                        <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div className="flex flex-col gap-3">
                                                <div><p className="text-xs text-muted-foreground mb-1">漏洞描述</p><p className="text-sm leading-relaxed">{vuln.description}</p></div>
                                                <div><p className="text-xs text-muted-foreground mb-1">发布日期</p><p className="text-sm font-mono">{vuln.publishDate}</p></div>
                                            </div>
                                            <div className="flex flex-col gap-3">
                                                <div className="p-3 rounded-lg bg-secondary/30 border border-border">
                                                    <p className="text-xs text-muted-foreground mb-2">修复建议</p>
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-xs text-muted-foreground">当前版本:</span>
                                                        <Badge variant="outline" className="text-[10px] border-red-500/20 text-red-500 bg-red-500/5">{vuln.version}</Badge>
                                                        <span className="text-xs text-muted-foreground">→</span>
                                                        <Badge variant="outline" className="text-[10px] border-emerald-500/20 text-emerald-500 bg-emerald-500/5">{vuln.fixVersion}</Badge>
                                                    </div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <Button size="sm" variant="outline" className="text-xs"><ExternalLink className="w-3 h-3 mr-1" />查看 CVE 详情</Button>
                                                    {vuln.status === 'open' && <Button size="sm" className="text-xs">开始修复</Button>}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </CardContent>
                        </Card>
                    )
                })}
            </div>
        </div>
    )
}
